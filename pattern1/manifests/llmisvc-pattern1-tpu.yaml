apiVersion: serving.kserve.io/v1alpha1
kind: LLMInferenceService
metadata:
  name: qwen2-3b-pattern1
  namespace: llm-d-inference-scheduling
spec:
  model:
    uri: hf://Qwen/Qwen2.5-3B-Instruct
    name: Qwen/Qwen2.5-3B-Instruct
  replicas: 1  # Pattern 1: single replica baseline

  # Router configuration
  router:
    route: {}      # Auto-create HTTPRoute
    gateway: {}    # Bind to Gateway
    scheduler: {}  # Enable EPP scheduler for intelligent routing

  # vLLM container template
  template:
    containers:
    - name: main
      image: registry.redhat.io/rhaiis/vllm-tpu-rhel9:3.2.5

      # vLLM arguments
      args:
      - --model=Qwen/Qwen2.5-3B-Instruct
      - --dtype=half
      - --max-model-len=2048
      - --tensor-parallel-size=4  # Match TPU chip count
      - --disable-log-requests

      # TPU environment variables
      env:
      - name: TPU_CHIPS_PER_HOST_BOUNDS
        value: "2,2,1"  # 2x2 topology for 4 chips
      - name: TPU_HOST_BOUNDS
        value: "1,1,1"  # Single host
      - name: PJRT_DEVICE
        value: "TPU"
      - name: HF_TOKEN
        valueFrom:
          secretKeyRef:
            name: huggingface-token
            key: HF_TOKEN

      # Resource allocation
      resources:
        limits:
          google.com/tpu: "4"  # MUST request all 4 chips
        requests:
          google.com/tpu: "4"

      # Health probes
      livenessProbe:
        httpGet:
          path: /health
          port: 8000
          scheme: HTTP
        initialDelaySeconds: 240  # TPU init (2-3 min) + model download + compilation
        periodSeconds: 30
        timeoutSeconds: 30
        failureThreshold: 5

      readinessProbe:
        httpGet:
          path: /v1/models
          port: 8000
          scheme: HTTP
        initialDelaySeconds: 240
        periodSeconds: 10
        timeoutSeconds: 10

    # TPU node selector
    nodeSelector:
      cloud.google.com/gke-tpu-topology: 2x2
      cloud.google.com/gke-tpu-accelerator: tpu-v6e

    # Pull secret
    imagePullSecrets:
    - name: 11009103-jhull-svc-pull-secret
